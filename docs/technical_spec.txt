# üìÑ **TECHNICAL_SPEC.md**

```markdown
# Technische Spezifikation ‚Äì Ecomm Agent  
Version 1.0 ¬∑ Stand: aktuelle Projektstruktur aus ZIP Archiv

---

## 1. Zielsetzung

Die Anwendung soll automatisiert:

- Produktbilder generieren  
- Bildanalysen bereitstellen  
- Promptvarianten aus der DB liefern  
- Produkte visuell & textuell darstellen  
- Workflows orchestrieren, √ºberwachen und loggen  

Sie dient als zentraler Hub zwischen Nutzer und einem externen **n8n Workflow**.

---

## 2. Systemkomponenten

### 2.1 Frontend
- `index.php` als UI-Container  
- `script.js` steuert:
  - Upload
  - Polling
  - Statusanzeigen
  - Bildslidere
  - Dynamische Layouts

### 2.2 Backend (PHP)
Hauptaufgaben:
- Authentifizierung
- Orchestrierung des Workflows
- Eingang der n8n-Callbacks
- Datenpersistenz (Runs, Images, Logs)
- Prompt-Variantenbereitstellung
- Settings-Funktionen f√ºr User

### 2.3 n8n Automationsserver
Nutzen:
- AI Bildanalyse
- Bildgenerierung via Diffusion Models
- Textgenerierung
- Multi-Image Logik (abh√§ngig von eingehenden Payloads)
- R√ºckgabe an `receiver.php`

---

## 3. Workflow Definition (technisch)

### 3.1 Upload
`upload.php`

Ablauf:
- Dateiannahme  
- Validierung  
- Speicherung im `/uploads`  
- Eintrag in `workflow_runs`  
- R√ºckgabe `run_id`

### 3.2 Workflow Start
`start-workflow.php`

Payload an n8n:

```json
{
  "run_id": <int>,
  "user_id": <int>,
  "image_url_1": "string",
  "image_url_2": "string|optional",
  "receiver_api_token": "string"
}

3.3 Prompt Variants Fetch

api/get-prompt-variants.php

N8n ruft diese API auf:

    User wird anhand des prompt_category_id gemappt

    passende Varianten geladen

3.4 n8n AI Prozess (aus Code abgeleitet)

    Garment Analyse

    Kombination (wenn mehrere Bilder)

    Generierung verschiedener Bildtypen

    Bewertung & Selektion

    Textgenerierung

    R√ºckgabe an Backend

3.5 Callback-Handling

receiver.php

Verarbeitet:

    statusmeldung

    images

    text

    garment analysis

    final product images

Speichert:

    Images in item_images

    Status in workflow_runs

    Logs in status_logs

3.6 Frontend Polling

Regelm√§√üig:

    get-runs.php

    get-run-details.php

Dient zur Live-Anzeige des Fortschritts.
4. Datenstrukturen
4.1 Run

id
user_id
created_at
status
original_image
last_message

4.2 Image

id
run_id
user_id
image_url | image_base64
type
created_at

4.3 Prompt Variant

id
category_id
label
LOCATION
LIGHTING
MOOD
SEASON
MODEL_TYPE
MODEL_POSE
VIEW_MODE

4.4 Status Log

id
run_id
user_id
message
created_at

5. Konfiguration (Technisch)

Die Konfigurationsdatei wird via:

$config = require __DIR__ . '/config.php';

geladen.

Sie enth√§lt:
‚Ä¢ Pfade

base_url, upload_dir, asset_base_url
‚Ä¢ n8n Integration

    workflow_webhook

    receiver_api_token

    receiver_api_allowed_ips

‚Ä¢ DB (PDO)

DSN + Credentials
‚Ä¢ SMTP

E-Mail Versand (Verifizierung / Reset)
6. Sicherheit
6.1 API Tokens

n8n ‚Üí Backend nutzt Header:

X-API-TOKEN: <receiver_api_token>

6.2 Berechtigungen

Nur authentifizierte User haben Zugriff auf:

    Upload

    Start Workflow

    Settings

    Run Details

6.3 SQL Sicherheit

Alle Queries via PDO Prepared Statements.
6.4 Upload Sicherheit

    mime-type check

    size checks

    unique filenames

7. Performance

    Frontend Polling kann sp√§ter per WebSocket ersetzt werden

    Base64 Images ‚Üí k√∂nnen sehr gro√ü werden

    Caching f√ºr Prompt-Varianten m√∂glich

    Asynchrone Verarbeitung √ºber n8n skaliert gut

