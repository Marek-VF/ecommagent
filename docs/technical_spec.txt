---

## ⚙️ `docs/technical_spec.txt`

```text
# Technische Spezifikation – Ecomm Agent
Stand: 10.11.2025

## 1. Überblick

Ecomm Agent ist eine PHP-8.2-Anwendung mit MySQL-8.4-Datenbank zur Steuerung eines externen n8n-Workflows.  
Ziel ist die halbautomatische Generierung von Produktdaten und Bildern aus Benutzer-Uploads.  
Das System ist multi-user-fähig und stellt eine Historie der Workflow-Durchläufe bereit.

---

## 2. Systemarchitektur

[Browser / Frontend]
   ⇄ (index.php + script.js)
   ⇄ API (get-latest-item, get-runs, get-run-details)
   ⇄ Backend-Controller (upload, start-workflow, receiver, webhook_image)
   ⇄ MySQL 8.4
   ⇄ n8n-Webhook-Endpunkte

### Komponenten

- **Frontend (index.php + script.js)**
  - Drag-&-Drop-Uploadzone
  - Formularfelder für Artikelnamen und Beschreibung
  - Drei dynamische Bilder-Slots (generierte Ergebnisse)
  - Sidebar mit Verlaufs-Runs
  - Status-Anzeige mit Polling (alle 2 Sekunden)
  - Fade-In-Effekte für Bilder
  - Dynamisches Umschalten bei Mehrfach-Uploads

- **Backend / Controller**
  - `upload.php` – Erstellt neuen Workflow-Run, speichert Datei(en)
  - `start-workflow.php` – Sendet Run-Daten und Bild-URLs an n8n
  - `receiver.php` – Nimmt n8n-Daten (JSON) mit Artikelnamen, Beschreibung, Status entgegen
  - `webhook_image.php` – Nimmt generierte Bilder (multipart/form-data) entgegen
  - `api/get-latest-item.php` – Zusammengeführte Sicht auf Run, Artikel, Bilder
  - `api/get-runs.php` – Listet alle Runs eines Benutzers
  - `api/get-run-details.php` – Liefert Details eines Runs

- **Auth-Schicht (auth/\*)**
  - Login, Registrierung, Passwort-Reset
  - Token-Verifizierung, Sessions, PHPMailer
  - Zugriffsschutz auf alle API-Endpunkte

- **Settings-Modul**
  - Benutzerprofil bearbeiten (Name, E-Mail)
  - Bildverhältnis-Einstellung speichern (`image_ratio_preference`)

---

## 3. Datenbankmodell

### Tabellen

- **users**  
  Benutzerkonto, Passworthash, Tokens, Verifizierungsstatus, Bildpräferenz
- **user_state**  
  Letzter Status je Benutzer, inklusive letztem `run_id`
- **workflow_runs**  
  Enthält jeden Workflow-Durchlauf (Status: pending, running, finished)
- **item_notes**  
  Produktname, Beschreibung, Quelle (von n8n geliefert)
- **item_images**  
  Generierte Bilder (von n8n über webhook_image.php)
- **status_logs**  
  Laufende Status-Updates zu jedem Run (von n8n gesendet)

---

## 4. Ablauf

1. Benutzer authentifiziert sich.  
2. Upload über `upload.php` → neuer Run + Datei speichern.  
3. Start-Button → `start-workflow.php` ruft konfigurierten n8n-Webhook auf.  
4. n8n verarbeitet Daten, ruft zurück:
   - `receiver.php` → JSON mit Artikeldaten und Status
   - `webhook_image.php` → generierte Bilder
5. Frontend pollt `get-latest-item.php` und aktualisiert UI.  
6. Historie der Runs abrufbar über Sidebar (API-Endpunkte).

---

## 5. Frontend-Verhalten

- Läuft komplett clientseitig über `script.js`
- Liest `APP_CONFIG` aus `index.php`
- Unterstützt Mehrfach-Uploads (max. 2 Bilder)
- Polling-Intervall: 2 Sekunden
- Zustand „Workflow abgeschlossen“ → Anzeige der generierten Daten
- Layout und Animationen vollständig in CSS (Dark Theme)

---

## 6. Sicherheit

- Sessions mit Secure-Cookies
- Passwort-Hashing via `password_hash()`
- Datenbankzugriff mit PDO Prepared Statements
- Bearer-Token-Prüfung für eingehende n8n-Webhooks
- Input-Validierung bei Uploads und API-Requests

---

## 7. Deployment-Hinweise

- PHP ≥ 8.2, MySQL ≥ 8.4, Apache mit Rewrite-Modul
- `config.php` enthält:
  - `base_url`
  - `upload_dir`
  - `workflow_webhook`
  - `receiver_api_token`
- Schreibrechte für Upload-Verzeichnis sicherstellen
- Datenbank nach `import.sql` importieren
- Erste Anmeldung über `/auth/register.php`

---

## 8. Erweiterungen (geplant)

- Wiedereinführung der Tabelle `run_images` für Original-Uploads  
- Erweiterte Statusanzeige mit Fortschritts-Balken  
- Option zum erneuten Ausführen eines Runs  
- Export-Funktion (JSON / CSV) der generierten Artikeldaten

---

## 9. Zusammenfassung

Ecomm Agent bildet eine stabile Schnittstelle zwischen Benutzer-Uploads und KI-gestützter Datenverarbeitung in n8n.  
Durch die modulare API-Architektur, Polling-Mechanismen und Multi-User-Unterstützung eignet sich das System als Grundlage für automatisierte Content-Pipelines im E-Commerce-Bereich.