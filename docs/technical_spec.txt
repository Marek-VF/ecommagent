2.1 Datenbankmodell (√úberblick)

Haupttabellen (aus import.sql):

users

Standard-Usertabelle (id, name, email, password_hash, email_verified, created_at, updated_at, etc.)

zus√§tzliche Felder:

prompt_category_id ‚Äì pr√§ferierte Prompt-Kategorie (FK zu prompt_categories)

image_ratio_preference ‚Äì z. B. 4:5, 1:1, original

weitere Einstellungen (Branche, etc., je nach Schema)

workflow_runs

Repr√§sentiert einen Workflow-Lauf pro Benutzer.

Wichtige Spalten:

id

user_id

started_at, finished_at

status (z. B. new, running, finished, error)

last_message (Text f√ºr Statusanzeige)

original_image (Pfad zum initial hochgeladenen Bild)

credits_spent (Summe der Credits f√ºr diesen Run)

last_step_status (success/error)

run_images

Bilder, die einem Run zugeordnet sind (generiert oder Platzhalter).

Wichtige Spalten:

id

run_id

user_id

file_path (relativer Pfad)

position (Slot im Frontend, z. B. 1‚Äì4)

note_id (FK zu item_notes, optional)

created_at

item_images

Bilder, die einem Item/Produkt zugeordnet sind (nicht nur run-bezogen; je nach Implementierung).

√Ñhnlich zu run_images mit Fokus auf (User, Run, Item).

item_notes

Textuelle Produktinfos pro Run (bzw. Produkt).

Spalten:

id

user_id

run_id

product_name

product_description

source (z. B. n8n, manual)

created_at, updated_at

status_logs_new

Statusprotokoll f√ºr Runs.

Spalten:

id

run_id

user_id

message

created_at

Bef√ºllt via status_logger.php::log_status_message().

credit_transactions

Historie der Creditbuchungen.

Spalten:

id

user_id

run_id (optional)

amount (decimal, z. B. -0.750)

reason (z. B. analysis, image_1)

meta (JSON, z. B. {"source":"webhook_image.php"})

created_at
products

Produkt- und Step-Definitionen (purchase_price in Cent, credits nicht mehr genutzt).

Spalten (Auszug):

product_key (Step-ID), type (step/package), label, purchase_price, price, currency, group_id, active

credit_packages

Credit-Pakete fuer den Checkout.

Spalten (Auszug):

package_key, label, credits, price, currency, active

options

Globale Pricing-Optionen (Key/Value).

Spalten (Auszug):

opt_key, opt_value (z. B. pricing.factor, pricing.credits_per_eur)

user_state

‚ÄúEphemerer‚Äù UI-State pro User.

Spalten:

user_id (UNIQUE)

current_run_id

last_status

last_message

last_image_url

updated_at

Wird in start-workflow.php, receiver.php, webhook_image.php und api/get-latest-item.php genutzt.

prompt_categories

Kategorien (z. B. fashion, interior).

Spalten:

id

category_key (String, z. B. fashion)

label (Anzeigename)

prompt_variants

Prompt-Varianten pro Kategorie & User.

Spalten:

id

user_id

category_id

variant_slot (1‚Äì3)

location, lighting, mood, season, model_type, model_pose, view_mode

created_at, updated_at

2.2 Backend-Hilfsfunktionen
2.2.1 db.php

getPDO(): PDO ‚Äì Singleton-PDO f√ºr alle DB-Zugriffe.

Diverse Helper:

db_query, db_fetch_one, db_fetch_all, etc.

Spezialisierte Methoden z. B.:

db_get_user_credits_balance(PDO $pdo, int $userId): float

db_log_credit_transaction(...)

db_get_prompt_category_id_by_key(...)

Wird in fast allen PHP-Dateien via require_once genutzt.

2.2.2 auth/bootstrap.php

Zentrale Auth-/Session-Schicht:

Session-Setup (session_set_cookie_params, session_start)

auth_config() ‚Äì l√§dt config.php

auth_pdo() ‚Äì liefert PDO aus db.php

auth_user() ‚Äì liefert User-Array aus Session

auth_is_logged_in()

auth_require_login($redirectPath) ‚Äì Redirect auf Login bei nicht eingeloggtem User

auth_set_user($userData) ‚Äì schreibt Userdaten in Session

auth_logout() ‚Äì l√∂scht Session & regeneriert ID

auth_redirect($path)

Passwort-Helpers:

auth_hash_password($password)

auth_verify_password($password, $hash)

Token-Helper:

auth_generate_token() (z. B. f√ºr E-Mail-Verification, Passwort-Reset)

Die anderen auth/*.php-Dateien nutzen diese Funktionen.

2.3 Credit-System (Details)

Definiert ueber Datenbanktabellen und credits.php:

Preise pro Step:

Tabelle products (type = 'step', active = 1, purchase_price > 0; Wert in Cent)

product_key entspricht step_type aus den Webhooks

credits.php:

get_credit_price(PDO , string ): ?float

berechnet den Preis aus products.purchase_price (Cent) und options (pricing.factor, pricing.credits_per_eur); null wenn nicht vorhanden

get_required_credits_for_run(PDO , int  = 1): float

summe aller aktiven Steps anhand purchase_price (group_id = 1), fallback: alle Steps

charge_credits(PDO , int , ?int , string , array ): void

ermittelt Preis

zieht users.credits_balance ab

erhoeht workflow_runs.credits_spent (wenn run_id vorhanden)

schreibt Datensatz in credit_transactions (negativer Betrag)

add_credits(PDO , int , float , string , array ): int

erhoeht users.credits_balance

schreibt Datensatz in credit_transactions (positiver Betrag)

Nutzung:

Vor Start des Workflows:
start-workflow.php ermittelt requiredCredits via get_required_credits_for_run()
und vergleicht mit users.credits_balance.
Bei zu wenig Credits: HTTP 400 mit not_enough_credits = true.

Pro Step:

receiver.php und api/get-prompt-variants.php (Text/Analyse)

webhook_image.php (Bild-Generierung)

immer nur, wenn executed_successfully === true und ein gueltiger step_type gesetzt ist.

Gutschrift (Aufladung):

api/paypal/capture-order.php und api/paypal/webhook.php

ruft add_credits() nach erfolgreichem Zahlungscapture auf.

Credit-Pakete (Checkout):

Tabelle credit_packages (package_key, label, credits, price, currency, active)

settings/credits.php listet aktive Pakete und startet den PayPal-Checkout.

2.4 n8n-Integration (Felder & Sicherheit)
2.4.1 Outgoing (Start Webhook)

start-workflow.php sendet via cURL:

URL: config['workflow_webhook']

Methode: POST, multipart/form-data

Felder:

file ‚Äì Hauptbild (CURLFile)

optional file_2 ‚Äì zweites Bild

image_ratio ‚Äì Ratio-Pr√§ferenz des Users ('original' oder z. B. '4:5')

run_id

user_id

ggf. weitere Metadaten, je nach Implementierung

2.4.2 Eingehende Webhooks (Callbacks)

Autorisierung:

receiver.php und webhook_image.php pr√ºfen Header Authorization: Bearer <token>.

api/get-prompt-variants.php pr√ºft Header X-API-TOKEN: <token>.

Der Token ist config['receiver_api_token'].

Wichtige Felder in den n8n-Requests (aus der PHP-Logik ablesbar):

run_id ‚Äì Pflicht zur Zuordnung

user_id ‚Äì sollte zu run.user_id passen

status / statusmeldung ‚Äì freier Text oder Deutsches Feld; status_logger.php extrahiert Meldung

product_name / produktname

product_description / produktbeschreibung

step_type ñ string, muss zu products.product_key (type = 'step') passen

executed_successfully ‚Äì kann true/false, 1/0, "true"/"false" sein

position ‚Äì Position des Bild-Slots (1‚Äì4)

note_id ‚Äì ID der item_notes-Zeile (optional; wird andernfalls erstellt)

Fehlerfall (executed_successfully === false):

webhook_image.php:

legt/ermittelt item_notes

speichert Platzhalterbild in run_images

schreibt Statuslog

keine Credits

2.5 Frontend-Logik (script.js)

Wichtige Konstanten:

RUNS_ENDPOINT = 'api/get-runs.php'

RUN_DETAILS_ENDPOINT = 'api/get-run-details.php'

uploadEndpoint = 'upload.php'

POLLING_INTERVAL = 2000 (ms)

DATA_ENDPOINT = 'api/get-latest-item.php'

Kern-Funktionalit√§t:

Upload und Preview

handleFiles(files) ‚Üí ruft uploadFile(file) pro Datei.

uploadFile(file) ‚Üí POST an upload.php, verarbeitet JSON, aktualisiert:

Preview-Liste (#upload-previews)

Originalimages-Bereich (data-original-images)

Start-Button-State

Statusliste (neuer Eintrag ‚ÄúBild hochgeladen‚Äù etc.)

Status & Polling

startPolling() / stopPolling()

pollLatestItem() ‚Üí fetch(DATA_ENDPOINT):

verarbeitet data:

run_id

isrunning

status

message

product_name, product_description

original_image, images (Liste)

ruft applyRunDataToUI().

History

loadRuns() ‚Üí fetch(RUNS_ENDPOINT), rendert Sidebar (#history-sidebar).

loadRunDetails(runId) ‚Üí fetch(RUN_DETAILS_ENDPOINT + '?id=...'), ruft applyRunDataToUI(data).

UI-Zust√§nde

Status-Bar: Klassen wie status--running, status--idle, etc.

Scan-Overlays: definierte CSS-Klassen (.scan-overlay, .scan-overlay.active)

Generated-Grid: Slots .generated-slot[data-slot="1..4"] mit Inline-Images + Buttons (2K / 4K / Edit ‚Äì aktuell noch Platzhalter ohne Backend-Funktion).

2.6 Settings & Prompt-Varianten

settings/default_variants.json definiert Standardvarianten f√ºr verschiedene Kategorien (z. B. fashion, interior), jeweils 3 Slots mit:

location

lighting

mood

season

model_type

model_pose

view_mode (full_body / garment_closeup)

settings/image_variants.php:

L√§dt aktuelle prompt_variants f√ºr den User.

Form zur Bearbeitung der Werte je Slot.

POST geht an settings/update_prompt_variants.php, schreibt in prompt_variants.

settings/image.php:

Formulare f√ºr:

image_ratio_preference (Select)

Auswahl der Standardkategorie etc.

POST an settings/update_image_settings.php.

settings/credits.php:

Zeigt aktuellen Kontostand (Balance aus credit_transactions).

Erkl√§rt Creditsystem f√ºr den User.

2.7 Sicherheit

Session-Cookies:

httponly = true

secure abh√§ngig von HTTPS

samesite = Lax

Passwort-Hashing mit password_hash() / password_verify().

E-Mail-Best√§tigung & Reset-Tokens per zuf√§lligen auth_generate_token() (32 Byte random).

n8n-Zugriff mit Bearer-Token / API-Token (kein anonymer Zugriff).

Input-Validation:

filter_var, is_numeric, intval etc. f√ºr IDs

prepared statements f√ºr DB-Zugriffe

Output-Encoding:

htmlspecialchars(...) an vielen Stellen in index.php, settings/*.php etc.



